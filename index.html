<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Recipe Generator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .sync-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .staples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        .collapse-transition {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Simple icon components
        const ChefHat = ({ className = "", size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="m15 11-1 9h-4l-1-9"/>
                <path d="m5 11 1-2c0-5 4-7 8-7s8 2 8 7l1 2-4.5 0.5"/>
                <path d="m4 11 5-8"/>
                <path d="m20 11-5-8"/>
            </svg>
        );

        const Plus = ({ size = 16 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M5 12h14"/>
                <path d="M12 5v14"/>
            </svg>
        );

        const Edit2 = ({ size = 14 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
        );

        const Trash2 = ({ size = 14 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3,6 5,6 21,6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        );

        const Check = ({ size = 14 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="20,6 9,17 4,12"/>
            </svg>
        );

        const Utensils = ({ size = 16 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/>
                <path d="M7 2v20"/>
                <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/>
            </svg>
        );

        const AlertTriangle = ({ className = "", size = 20 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
        );

        const Cloud = ({ size = 16 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
            </svg>
        );

        const User = ({ size = 16 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        );

        const X = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 6 6 18"/>
                <path d="M6 6l12 12"/>
            </svg>
        );

        const ChevronDown = ({ size = 16, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
        );

        const Droplet = ({ size = 16 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
            </svg>
        );

        // Kitchen staples data
        const KITCHEN_STAPLES = {
            oils: {
                name: "Oils & Fats",
                icon: <Droplet size={16} />,
                items: [
                    "Olive oil (extra virgin)",
                    "Olive oil (light or regular)",
                    "Vegetable oil",
                    "Canola oil",
                    "Avocado oil",
                    "Coconut oil (refined)",
                    "Coconut oil (virgin)",
                    "Sesame oil (toasted)",
                    "Grapeseed oil",
                    "Sunflower oil",
                    "Peanut oil",
                    "Corn oil",
                    "Safflower oil",
                    "Soybean oil",
                    "Walnut oil",
                    "Flaxseed oil",
                    "Pumpkin seed oil",
                    "Butter (salted)",
                    "Butter (unsalted)",
                    "Ghee / Clarified butter",
                    "Lard",
                    "Duck fat",
                    "Bacon grease",
                    "Shortening (e.g., Crisco)"
                ]
            },
            seasonings: {
                name: "Seasonings & Spices",
                icon: "üåø",
                subcategories: {
                    "Herbs (dried)": [
                        "Basil",
                        "Oregano",
                        "Thyme",
                        "Rosemary",
                        "Parsley",
                        "Dill",
                        "Sage",
                        "Marjoram",
                        "Bay leaves",
                        "Tarragon",
                        "Cilantro",
                        "Mint"
                    ],
                    "Spices": [
                        "Black pepper",
                        "White pepper",
                        "Crushed red pepper",
                        "Cayenne pepper",
                        "Chili powder",
                        "Smoked paprika",
                        "Sweet paprika",
                        "Cumin",
                        "Coriander",
                        "Turmeric",
                        "Ginger (ground)",
                        "Nutmeg",
                        "Cloves (ground or whole)",
                        "Allspice",
                        "Cardamom",
                        "Cinnamon",
                        "Mustard powder",
                        "Fennel seed",
                        "Caraway seed",
                        "Anise seed"
                    ],
                    "Seasoning Blends": [
                        "Italian seasoning",
                        "Herbs de Provence",
                        "Taco seasoning",
                        "Cajun seasoning",
                        "Creole seasoning",
                        "Old Bay",
                        "Garam masala",
                        "Chinese five spice",
                        "Za'atar",
                        "Curry powder",
                        "Ras el hanout",
                        "Chili flakes (gochugaru, aleppo, etc.)"
                    ],
                    "Salts": [
                        "Kosher salt",
                        "Sea salt",
                        "Table salt",
                        "Himalayan pink salt",
                        "Flaky salt (e.g., Maldon)",
                        "Garlic salt",
                        "Celery salt",
                        "Onion salt",
                        "Seasoned salt"
                    ],
                    "Other": [
                        "MSG (e.g., Ajinomoto)",
                        "Bouillon (cubes or paste: chicken, beef, veg)",
                        "Nutritional yeast"
                    ]
                }
            },
            vinegars: {
                name: "Vinegars",
                icon: "üçæ",
                items: [
                    "Distilled white vinegar",
                    "Apple cider vinegar",
                    "White wine vinegar",
                    "Red wine vinegar",
                    "Balsamic vinegar",
                    "Sherry vinegar",
                    "Champagne vinegar",
                    "Rice vinegar (unseasoned)",
                    "Seasoned rice vinegar",
                    "Malt vinegar",
                    "Coconut vinegar",
                    "Black vinegar (Chinese/Zhenjiang)",
                    "Cane vinegar",
                    "Ume plum vinegar"
                ]
            },
            condimentsAndSweeteners: {
                name: "Condiments & Sweeteners",
                icon: "üçØ",
                subcategories: {
                    "Condiments": [
                        "Ketchup",
                        "Mustard (yellow)",
                        "Dijon mustard",
                        "Spicy brown mustard",
                        "Whole grain mustard",
                        "Mayonnaise",
                        "Miracle Whip",
                        "Relish (sweet or dill)",
                        "Sriracha",
                        "Hot sauce (e.g., Tabasco, Frank's)",
                        "Chili garlic sauce",
                        "Gochujang",
                        "Harissa",
                        "Hoisin sauce",
                        "Fish sauce",
                        "Oyster sauce",
                        "Soy sauce",
                        "Tamari",
                        "Coconut aminos",
                        "Worcestershire sauce",
                        "BBQ sauce",
                        "Buffalo sauce",
                        "Teriyaki sauce",
                        "Tzatziki",
                        "Tahini",
                        "Hummus",
                        "Pesto",
                        "Salsa",
                        "Guacamole",
                        "Curry paste (red/green/yellow)",
                        "Tomato paste",
                        "Tomato sauce",
                        "Marinara",
                        "Mole",
                        "Chimichurri",
                        "Aioli"
                    ],
                    "Sweeteners": [
                        "Granulated white sugar",
                        "Brown sugar (light and dark)",
                        "Powdered sugar",
                        "Cane sugar",
                        "Turbinado sugar",
                        "Honey",
                        "Maple syrup",
                        "Agave syrup",
                        "Corn syrup",
                        "Molasses (light or blackstrap)",
                        "Date syrup",
                        "Coconut sugar",
                        "Stevia",
                        "Monk fruit sweetener",
                        "Erythritol",
                        "Artificial sweeteners (Splenda, etc.)"
                    ]
                }
            }
        };
        // Add this function after the icon components
        const formatRecipeText = (text) => {
            if (!text) return '';
            
            // Convert markdown-style formatting to HTML
            let formatted = text
                // Headers (## Title -> <h3>Title</h3>)
                .replace(/^### (.*$)/gm, '<h4 class="font-semibold text-gray-800 mt-4 mb-2 text-base">$1</h4>')
                .replace(/^## (.*$)/gm, '<h3 class="font-bold text-gray-900 mt-4 mb-3 text-lg">$1</h3>')
                .replace(/^# (.*$)/gm, '<h2 class="font-bold text-gray-900 mt-4 mb-3 text-xl">$1</h2>')
                
                // Bold text (**text** -> <strong>text</strong>)
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-800">$1</strong>')
                
                // Italic text (*text* -> <em>text</em>)
                .replace(/\*(.*?)\*/g, '<em class="italic text-gray-700">$1</em>')
                
                // Numbered lists (1. item -> proper HTML list)
                .replace(/^\d+\.\s+(.+$)/gm, '<li class="mb-1 ml-4">$1</li>')
                
                // Bullet points (- item or * item -> proper HTML list)
                .replace(/^[-*]\s+(.+$)/gm, '<li class="mb-1 ml-4 list-disc">$1</li>')
                
                // Convert line breaks to proper spacing
                .replace(/\n\n/g, '</p><p class="mb-3">')
                .replace(/\n/g, '<br />');
            
            // Wrap in paragraph tags and handle lists
            formatted = '<p class="mb-3">' + formatted + '</p>';
            
            // Clean up and wrap lists properly
            formatted = formatted
                .replace(/(<li[^>]*>.*?<\/li>)/gs, (match) => {
                    return match;
                })
                // Wrap consecutive <li> elements in <ul> or <ol>
                .replace(/(<li class="mb-1 ml-4 list-disc"[^>]*>.*?<\/li>)/gs, (match) => {
                    return match.replace(/class="mb-1 ml-4 list-disc"/g, 'class="mb-1"');
                })
                .replace(/(<li class="mb-1 ml-4"[^>]*>.*?<\/li>)/gs, (match) => {
                    return match.replace(/class="mb-1 ml-4"/g, 'class="mb-1"');
                });
            
            // Wrap bullet point lists
            formatted = formatted.replace(
                /(<li class="mb-1"[^>]*>.*?<\/li>(?:\s*<li class="mb-1"[^>]*>.*?<\/li>)*)/gs,
                '<ol class="list-decimal ml-6 mb-4">$1</ol>'
            );
            
            // Wrap numbered lists  
            formatted = formatted.replace(
                /(<li class="mb-1 list-disc"[^>]*>.*?<\/li>(?:\s*<li class="mb-1 list-disc"[^>]*>.*?<\/li>)*)/gs,
                '<ul class="list-disc ml-6 mb-4">$1</ul>'
            );
            
            return formatted;
        };
        const RecipeGenerator = () => {
            // User management functions
            const getUserId = () => {
                // First check if user has set a custom username
                let username = localStorage.getItem('username');
                if (username) {
                    return username;
                }
                
                // Otherwise use the auto-generated ID
                let userId = localStorage.getItem('user_id');
                if (!userId) {
                    userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                    localStorage.setItem('user_id', userId);
                }
                return userId;
            };

        const setUsername = (newUsername) => {
            if (!newUsername || newUsername.trim() === '') return false;
            
            const cleanUsername = newUsername.toLowerCase().replace(/[^a-z0-9-_]/g, '');
            if (cleanUsername.length < 2) {
                alert('Username must be at least 2 characters long');
                return false;
            }
            
            console.log('üîÑ Starting user switch to:', cleanUsername);
            
            // IMMEDIATELY stop ALL background activity
            setIsSwitchingUsers(true);
            setHasUnsavedChanges(false);
            setIsUserActive(false);
            lastUserActionRef.current = 0;
            
            // Clear any pending timeouts
            if (syncTimeoutRef.current) {
                clearTimeout(syncTimeoutRef.current);
                syncTimeoutRef.current = null;
            }
            
            // Update localStorage first
            localStorage.setItem('username', cleanUsername);
            setShowUserModal(false);
            
            // Force update userId and load data in one go
            setUserId(cleanUsername);
            
            // Use a longer delay and explicit user ID to avoid race conditions
            setTimeout(async () => {
                console.log('üîÑ Loading data for user:', cleanUsername);
                
                try {
                    const response = await fetch(`/.netlify/functions/github-sync?userId=${cleanUsername}`, {
                        method: 'GET',
                    });
        
                    if (response.ok) {
                        const data = await response.json();
                        console.log('üì¶ Loaded data for', cleanUsername, ':', data);
                        
                        // Update state with explicit data
                        setIngredients(data.ingredients || []);
                        setEquipment(data.equipment || []);
                        setKitchenStaples(data.kitchenStaples || {});
                        setCustomStaples(data.customStaples || {});
                        setSavedRecipes(data.savedRecipes || []);
                        
                        console.log('‚úÖ State updated for user:', cleanUsername);
                    } else {
                        console.log('üì¶ No data found for user:', cleanUsername, 'setting empty data');
                        setIngredients([]);
                        setEquipment([]);
                        setKitchenStaples({});
                        setSavedRecipes([]);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading data for user:', cleanUsername, error);
                    setIngredients([]);
                    setEquipment([]);
                    setKitchenStaples({});
                    setSavedRecipes([]);
                }
                
                // Re-enable auto-save after a longer delay
                setTimeout(() => {
                    console.log('‚úÖ Re-enabling auto-save for user:', cleanUsername);
                    setIsSwitchingUsers(false);
                }, 2000);
                
            }, 500);
            
            return true;
        };
            
            const debugUserIdState = () => {
                console.log('=== USER ID DEBUG ===');
                console.log('Current userId state:', userId);
                console.log('localStorage username:', localStorage.getItem('username'));
                console.log('localStorage user_id:', localStorage.getItem('user_id'));
                console.log('getUserId() returns:', getUserId());
                console.log('isSwitchingUsers:', isSwitchingUsers);
                console.log('=== END USER ID DEBUG ===');
            };
            
            const clearUsername = () => {
                console.log('Clearing username and switching to anonymous user');
                
                // Clear any pending operations
                if (syncTimeoutRef.current) {
                    clearTimeout(syncTimeoutRef.current);
                    syncTimeoutRef.current = null;
                }
                
                // Reset flags
                setIsSwitchingUsers(true);
                setHasUnsavedChanges(false);
                setIsUserActive(false);
                setEditingItem(null);
                lastUserActionRef.current = 0;
                
                // Remove username and generate new random user ID
                localStorage.removeItem('username');
                const newId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem('user_id', newId);
                
                setUserId(newId);
                setShowUserModal(false);
                
                // Set default data for anonymous user
                setIngredients([
                    { id: 1, name: 'Chicken Breast', quantity: 2, unit: 'lbs', category: 'Protein', expires: '2025-08-05' },
                    { id: 2, name: 'Basmati Rice', quantity: 1, unit: 'cup', category: 'Grain', expires: '2026-01-01' },
                    { id: 3, name: 'Heavy Cream', quantity: 1, unit: 'cup', category: 'Dairy', expires: '2025-08-03' },
                    { id: 4, name: 'Mushrooms', quantity: 8, unit: 'oz', category: 'Vegetable', expires: '2025-08-04' }
                ]);
                setEquipment([
                    { id: 1, name: 'Sous Vide Immersion Circulator', type: 'Precision Cooking', capabilities: 'Precise temperature control, long slow cooking' },
                    { id: 2, name: 'Cast Iron Dutch Oven', type: 'Cooking', capabilities: 'Braising, bread baking, high heat retention' }
                ]);
                setKitchenStaples({});
                setSavedRecipes([]);
                setCustomStaples({});
                
                // Re-enable auto-save after delay
                setTimeout(() => {
                    setIsSwitchingUsers(false);
                    console.log('Anonymous user setup complete');
                }, 1000);
            };

            const getApiKey = () => {
                let apiKey = localStorage.getItem('anthropic_api_key');
                if (!apiKey) {
                    apiKey = prompt('Please enter your Anthropic API key (starts with sk-ant-):');
                    if (apiKey) {
                        localStorage.setItem('anthropic_api_key', apiKey);
                    }
                }
                return apiKey;
            };

            const [ingredients, setIngredients] = useState([
                { id: 1, name: 'Chicken Breast', quantity: 2, unit: 'lbs', category: 'Protein', expires: '2025-08-05' },
                { id: 2, name: 'Basmati Rice', quantity: 1, unit: 'cup', category: 'Grain', expires: '2026-01-01' },
                { id: 3, name: 'Heavy Cream', quantity: 1, unit: 'cup', category: 'Dairy', expires: '2025-08-03' },
                { id: 4, name: 'Mushrooms', quantity: 8, unit: 'oz', category: 'Vegetable', expires: '2025-08-04' }
            ]);
            const [equipment, setEquipment] = useState([
                { id: 1, name: 'Sous Vide Immersion Circulator', type: 'Precision Cooking', capabilities: 'Precise temperature control, long slow cooking' },
                { id: 2, name: 'Cast Iron Dutch Oven', type: 'Cooking', capabilities: 'Braising, bread baking, high heat retention' }
            ]);
            const [kitchenStaples, setKitchenStaples] = useState({});
            const [savedRecipeContent, setSavedRecipeContent] = useState('');
            const [customStaples, setCustomStaples] = useState({});
            const [showAddCustomStaple, setShowAddCustomStaple] = useState('');
            const [customStapleInput, setCustomStapleInput] = useState('');
            const [savedRecipes, setSavedRecipes] = useState([]);
            const [activeTab, setActiveTab] = useState('ingredients');
            const [editingItem, setEditingItem] = useState(null);
            const [generatedRecipe, setGeneratedRecipe] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [recipePreferences, setRecipePreferences] = useState('');
            const [isSyncing, setIsSyncing] = useState(false);
            const [syncStatus, setSyncStatus] = useState('synced'); // 'synced', 'syncing', 'error'
            const [userId, setUserId] = useState(getUserId());
            const [showUserModal, setShowUserModal] = useState(false);
            const [usernameInput, setUsernameInput] = useState('');
            const [collapsedCategories, setCollapsedCategories] = useState({});
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
            const [isUserActive, setIsUserActive] = useState(false);
            const [isSwitchingUsers, setIsSwitchingUsers] = useState(false);
            const [isInitialLoad, setIsInitialLoad] = useState(true);
            const lastUserActionRef = useRef(Date.now());
            const syncTimeoutRef = useRef(null);
           // Track user activity
            const trackUserAction = () => {
                lastUserActionRef.current = Date.now();
                setIsUserActive(true);
                setHasUnsavedChanges(true);
                
                // Clear the "user active" flag after 5 seconds of inactivity
                setTimeout(() => {
                    if (Date.now() - lastUserActionRef.current >= 5000) {
                        setIsUserActive(false);
                    }
                }, 5000);
            };
            
            // ADD THESE TWO FUNCTIONS RIGHT HERE:
            const debugUserData = async () => {
                console.log('=== DEBUG USER DATA ===');
                console.log('Current userId:', userId);
                console.log('Current ingredients state:', ingredients);
                console.log('Current equipment state:', equipment);
                console.log('isSwitchingUsers:', isSwitchingUsers);
                console.log('isInitialLoad:', isInitialLoad);
                
                try {
                    // Test the API directly
                    const response = await fetch(`/.netlify/functions/github-sync?userId=${userId}`, {
                        method: 'GET',
                    });
                    
                    console.log('Raw API response status:', response.status);
                    
                    if (response.ok) {
                        const rawData = await response.text();
                        console.log('Raw API response text:', rawData);
                        
                        try {
                            const data = JSON.parse(rawData);
                            console.log('Parsed API data:', data);
                            console.log('API ingredients:', data.ingredients);
                            console.log('API equipment:', data.equipment);
                            console.log('API ingredients length:', data.ingredients?.length);
                            console.log('API equipment length:', data.equipment?.length);
                        } catch (parseError) {
                            console.error('Failed to parse API response as JSON:', parseError);
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('API error response:', errorText);
                    }
                } catch (error) {
                    console.error('Network error:', error);
                }
                
                console.log('=== END DEBUG ===');
            };
            
            const loadDataFromDatabaseDebug = async (forceLoad = false) => {
                console.log('üîÑ loadDataFromDatabase called');
                console.log('  - forceLoad:', forceLoad);
                console.log('  - isUserActive:', isUserActive);
                console.log('  - hasUnsavedChanges:', hasUnsavedChanges);
                console.log('  - userId:', userId);
                
                // Don't load if user is actively editing or has unsaved changes, unless forced
                if (!forceLoad && (isUserActive || hasUnsavedChanges)) {
                    console.log('‚ùå Skipping load - user is active or has unsaved changes');
                    return;
                }
                
                try {
                    setIsSyncing(true);
                    console.log('üì° Loading data for user:', userId);
                    
                    const response = await fetch(`/.netlify/functions/github-sync?userId=${userId}`, {
                        method: 'GET',
                    });
            
                    console.log('üì° Response status:', response.status);
            
                    if (response.ok) {
                        const data = await response.json();
                        console.log('üì¶ Received data:', data);
                        console.log('üì¶ data.ingredients:', data.ingredients);
                        console.log('üì¶ data.equipment:', data.equipment);
                        console.log('üì¶ data.kitchenStaples:', data.kitchenStaples);
                        
                        // Log what we're about to set
                        console.log('üîß About to update state...');
                        
                        if (data.hasOwnProperty('ingredients')) {
                            console.log('üîß Setting ingredients to:', data.ingredients || []);
                            setIngredients(data.ingredients || []);
                        } else {
                            console.log('‚ö†Ô∏è No ingredients property in data');
                        }
                        
                        if (data.hasOwnProperty('equipment')) {
                            console.log('üîß Setting equipment to:', data.equipment || []);
                            setEquipment(data.equipment || []);
                        } else {
                            console.log('‚ö†Ô∏è No equipment property in data');
                        }
                        
                        if (data.hasOwnProperty('kitchenStaples')) {
                            console.log('üîß Setting kitchenStaples to:', data.kitchenStaples || {});
                            setKitchenStaples(data.kitchenStaples || {});
                        } else {
                            console.log('‚ö†Ô∏è No kitchenStaples property in data');
                        }
                        
                        if (data.hasOwnProperty('savedRecipes')) {
                            console.log('üîß Setting savedRecipes to:', data.savedRecipes || []);
                            setSavedRecipes(data.savedRecipes || []);
                        } else {
                            console.log('‚ö†Ô∏è No savedRecipes property in data');
                        }
                        
                        setSyncStatus('synced');
                        console.log('‚úÖ State update complete');
                    } else {
                        const errorText = await response.text();
                        console.error('‚ùå Failed to load data:', response.status, errorText);
                        setSyncStatus('error');
                    }
                } catch (error) {
                    console.error('‚ùå Error loading data:', error);
                    setSyncStatus('error');
                } finally {
                    setIsSyncing(false);
                    console.log('üîÑ loadDataFromDatabase finished');
                }
            };

            // Load data from database on component mount ONLY
            useEffect(() => {
                const initialLoad = async () => {
                    console.log('üöÄ Initial load for user:', userId);
                    await loadDataFromDatabase(true);
                    setIsInitialLoad(false);
                };
                initialLoad();
                // NO PERIODIC LOADING - this was causing the conflicts
            }, []); // Empty dependency array
            // Auto-save to database when data changes (debounced)
            useEffect(() => {
                // COMPLETELY DISABLE auto-save during these conditions
                if (!userId || isSwitchingUsers || isInitialLoad || lastUserActionRef.current === 0) {
                    return;
                }
                
                if (syncTimeoutRef.current) {
                    clearTimeout(syncTimeoutRef.current);
                }
                
                setHasUnsavedChanges(true);
                
                syncTimeoutRef.current = setTimeout(() => {
                    // Double-check userId hasn't changed during the timeout
                    if (!isSwitchingUsers && userId) {
                        console.log('üíæ Auto-saving for user:', userId);
                        saveDataToDatabase();
                        setHasUnsavedChanges(false);
                    }
                }, 2000);
            
                return () => {
                    if (syncTimeoutRef.current) {
                        clearTimeout(syncTimeoutRef.current);
                    }
                };
            }, [ingredients, equipment, kitchenStaples, customStaples, savedRecipes, userId]); // Remove the switching flags from dependencies
            
            const loadDataFromDatabase = async (forceLoad = false) => {
                // Don't load if user is actively editing or has unsaved changes, unless forced
                if (!forceLoad && (isUserActive || hasUnsavedChanges)) {
                    console.log('Skipping load - user is active or has unsaved changes');
                    return;
                }
                
                try {
                    setIsSyncing(true);
                    console.log('Loading data for user:', userId);
                    
                    const response = await fetch(`/.netlify/functions/github-sync?userId=${userId}`, {
                        method: 'GET',
                    });
            
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Received data from database:', data);
                        
                        // Always update state with database data, even if empty
                        setIngredients(data.ingredients || []);
                        setEquipment(data.equipment || []);
                        setKitchenStaples(data.kitchenStaples || {});
                        setSavedRecipes(data.savedRecipes || []);
                        setCustomStaples(data.customStaples || {});
                        setSyncStatus('synced');
                        
                        console.log('State updated with database data');
                    } else {
                        console.error('Failed to load data:', response.status);
                        setSyncStatus('error');
                        
                        // Only fallback to localStorage for anonymous users
                        if (userId.startsWith('user_')) {
                            console.log('Database failed for anonymous user, falling back to localStorage');
                            const savedIngredients = localStorage.getItem('ingredients');
                            const savedEquipment = localStorage.getItem('equipment');
                            const savedStaples = localStorage.getItem('kitchenStaples');
                            const savedRecipesData = localStorage.getItem('savedRecipes');
                            
                            if (savedIngredients) setIngredients(JSON.parse(savedIngredients));
                            if (savedEquipment) setEquipment(JSON.parse(savedEquipment));
                            if (savedStaples) setKitchenStaples(JSON.parse(savedStaples));
                            if (savedRecipesData) setSavedRecipes(JSON.parse(savedRecipesData));
                        }
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    setSyncStatus('error');
                    
                    // Only fallback to localStorage for anonymous users
                    if (userId.startsWith('user_')) {
                        console.log('Network error for anonymous user, falling back to localStorage');
                        const savedIngredients = localStorage.getItem('ingredients');
                        const savedEquipment = localStorage.getItem('equipment');
                        const savedStaples = localStorage.getItem('kitchenStaples');
                        const savedRecipesData = localStorage.getItem('savedRecipes');
                        
                        if (savedIngredients) setIngredients(JSON.parse(savedIngredients));
                        if (savedEquipment) setEquipment(JSON.parse(savedEquipment));
                        if (savedStaples) setKitchenStaples(JSON.parse(savedStaples));
                        if (savedRecipesData) setSavedRecipes(JSON.parse(savedRecipesData));
                    }
                } finally {
                    setIsSyncing(false);
                }
            };

            const saveDataToDatabase = async () => {
                try {
                    setSyncStatus('syncing');
                    console.log('Saving data for user:', userId);
                    
                    const response = await fetch('/.netlify/functions/github-sync', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: userId,
                            ingredients: ingredients,
                            equipment: equipment,
                            kitchenStaples: kitchenStaples,
                            customStaples: customStaples,
                            savedRecipes: savedRecipes
                        })
                    });
            
                    if (response.ok) {
                        setSyncStatus('synced');
                        // Only save to localStorage for anonymous users as backup
                        if (userId.startsWith('user_')) {
                            localStorage.setItem('ingredients', JSON.stringify(ingredients));
                            localStorage.setItem('equipment', JSON.stringify(equipment));
                            localStorage.setItem('kitchenStaples', JSON.stringify(kitchenStaples));
                            localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
                        }
                    } else {
                        console.error('Save failed:', response.status);
                        setSyncStatus('error');
                    }
                } catch (error) {
                    console.error('Error saving data:', error);
                    setSyncStatus('error');
                    // Only fallback to localStorage for anonymous users
                    if (userId.startsWith('user_')) {
                        localStorage.setItem('ingredients', JSON.stringify(ingredients));
                        localStorage.setItem('equipment', JSON.stringify(equipment));
                        localStorage.setItem('kitchenStaples', JSON.stringify(kitchenStaples));
                        localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
                    }
                }
            };

            const markAsUsed = (id) => {
                trackUserAction();
                setIngredients(ingredients.filter(item => item.id !== id));
            };

            const updateQuantity = (id, newQuantity) => {
                trackUserAction();
                if (newQuantity <= 0) {
                    markAsUsed(id);
                } else {
                    setIngredients(ingredients.map(item => 
                        item.id === id ? { ...item, quantity: newQuantity } : item
                    ));
                }
            };

            const addIngredient = () => {
                trackUserAction();
                const newIngredient = {
                    id: Date.now(),
                    name: 'New Ingredient',
                    quantity: 1,
                    unit: 'unit',
                    category: 'Other',
                    expires: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                };
                setIngredients([...ingredients, newIngredient]);
                setEditingItem({ type: 'ingredient', id: newIngredient.id });
            };

            const addEquipment = () => {
                trackUserAction();
                const newEquipment = {
                    id: Date.now(),
                    name: 'New Equipment',
                    type: 'Other',
                    capabilities: 'Describe what this equipment can do'
                };
                setEquipment([...equipment, newEquipment]);
                setEditingItem({ type: 'equipment', id: newEquipment.id });
            };

            const deleteIngredient = (id) => {
                trackUserAction();
                setIngredients(ingredients.filter(item => item.id !== id));
            };

            const deleteEquipment = (id) => {
                trackUserAction();
                setEquipment(equipment.filter(item => item.id !== id));
            };

            const updateIngredient = (id, field, value) => {
                trackUserAction();
                setIngredients(ingredients.map(item => 
                    item.id === id ? { ...item, [field]: value } : item
                ));
            };

            const updateEquipment = (id, field, value) => {
                trackUserAction();
                setEquipment(equipment.map(item => 
                    item.id === id ? { ...item, [field]: value } : item
                ));
            };

            const toggleStaple = (itemName) => {
                trackUserAction();
                setKitchenStaples(prev => ({
                    ...prev,
                    [itemName]: !prev[itemName]
                }));
            };
            const saveRecipe = (recipeText) => {
                if (!recipeText.trim()) return;
                
                trackUserAction();
                const newRecipe = {
                    id: Date.now(),
                    title: extractRecipeTitle(recipeText),
                    content: recipeText,
                    createdAt: new Date().toISOString(),
                    ingredients: ingredients.map(ing => `${ing.name} (${ing.quantity} ${ing.unit})`),
                    preferences: recipePreferences
                };
                
                setSavedRecipes(prev => [newRecipe, ...prev]);
            };
            
            const extractRecipeTitle = (recipeText) => {
                const lines = recipeText.split('\n');
                const titleLine = lines.find(line => line.trim() && !line.startsWith('##') && !line.startsWith('*'));
                return titleLine ? titleLine.trim().replace(/^#+\s*/, '').substring(0, 60) : 'Untitled Recipe';
            };
            
            const deleteRecipe = (id) => {
                trackUserAction();
                setSavedRecipes(prev => prev.filter(recipe => recipe.id !== id));
            };
            const toggleCategory = (categoryKey) => {
                setCollapsedCategories(prev => ({
                    ...prev,
                    [categoryKey]: !prev[categoryKey]
                }));
            };

            const getSelectedStaplesCount = () => {
                const regularStaples = Object.values(kitchenStaples).filter(Boolean).length;
                const customStaplesCount = Object.values(customStaples).filter(Boolean).length;
                return regularStaples + customStaplesCount;
            };

            const generateRecipe = async () => {
                setSavedRecipeContent('');
                const apiKey = getApiKey();
                if (!apiKey) {
                    alert('API key is required to generate recipes');
                    return;
                }

                setIsGenerating(true);
                setGeneratedRecipe('');

                try {
                    const ingredientsList = ingredients.map(ing => 
                        `${ing.name} (${ing.quantity} ${ing.unit})`
                    ).join(', ');

                    const equipmentList = equipment.map(eq => 
                        `${eq.name} - ${eq.capabilities}`
                    ).join(', ');

                    // Get selected staples (both regular and custom)
                    const selectedRegularStaples = Object.entries(kitchenStaples)
                        .filter(([_, selected]) => selected)
                        .map(([name, _]) => name);
                        
                    const selectedCustomStaples = Object.entries(customStaples)
                        .filter(([_, selected]) => selected)
                        .map(([name, _]) => name);
                        
                    const selectedStaples = [...selectedRegularStaples, ...selectedCustomStaples].join(', ');

                    const prompt = `Create a detailed recipe using these available ingredients: ${ingredientsList}

Available specialized equipment: ${equipmentList}

Kitchen staples I have: ${selectedStaples || 'No staples selected'}

User preferences/notes: ${recipePreferences || 'No specific preferences'}

Please create a recipe that:
1. Uses primarily the ingredients I have available
2. Takes advantage of my specialized kitchen equipment when possible
3. Can utilize any of my kitchen staples as needed
4. Includes clear step-by-step instructions
5. Mentions cooking times and temperatures
6. If I'm missing any key ingredients, suggest simple substitutions or mention they're optional

Format the recipe with a clear title, ingredient list, and numbered steps.`;

                    const response = await fetch("/.netlify/functions/generate-recipe", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            apiKey: apiKey
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    setGeneratedRecipe(data.content[0].text);
                } catch (error) {
                    console.error("Error generating recipe:", error);
                    setGeneratedRecipe(`Error generating recipe: ${error.message}`);
                } finally {
                    setIsGenerating(false);
                }
            };

            const isExpiringSoon = (expirationDate) => {
                const today = new Date();
                const expiry = new Date(expirationDate);
                const diffTime = expiry - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 3 && diffDays >= 0;
            };

            const expiringSoon = ingredients.filter(ing => isExpiringSoon(ing.expires));

            const getSyncStatusInfo = () => {
                switch (syncStatus) {
                    case 'syncing':
                        return { color: 'text-blue-500', text: 'Syncing...', icon: <Cloud className="sync-indicator" /> };
                    case 'synced':
                        return { color: 'text-green-500', text: 'Synced', icon: <Cloud /> };
                    case 'error':
                        return { color: 'text-red-500', text: 'Sync Error', icon: <Cloud /> };
                    default:
                        return { color: 'text-gray-500', text: 'Unknown', icon: <Cloud /> };
                }
            };

            const statusInfo = getSyncStatusInfo();

            const renderStapleCategory = (categoryKey, categoryData) => {
                const isCollapsed = collapsedCategories[categoryKey];
                
                return (
                    <div key={categoryKey} className="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <button
                            onClick={() => toggleCategory(categoryKey)}
                            className="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between"
                        >
                            <div className="flex items-center gap-2 font-medium text-gray-800">
                                <span className="text-lg">{categoryData.icon}</span>
                                <span>{categoryData.name}</span>
                            </div>
                            <ChevronDown 
                                size={20} 
                                className={`text-gray-500 transition-transform ${isCollapsed ? '' : 'rotate-180'}`}
                            />
                        </button>
                        
                        {!isCollapsed && (
                            <div className="p-4">
                                {categoryData.subcategories ? (
                                    // Render subcategories
                                    Object.entries(categoryData.subcategories).map(([subName, items]) => (
                                        <div key={subName} className="mb-4">
                                            <h4 className="font-medium text-gray-700 mb-2 text-sm">{subName}</h4>
                                            <div className="staples-grid">
                                                {items.map(item => (
                                                    <label key={item} className="flex items-center gap-2 text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            checked={kitchenStaples[item] || false}
                                                            onChange={() => toggleStaple(item)}
                                                            className="w-4 h-4 text-blue-500 rounded focus:ring-blue-500"
                                                        />
                                                        <span className="text-gray-700">{item}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    // Render simple items
                                    <div className="staples-grid">
                                        {categoryData.items.map(item => (
                                            <label key={item} className="flex items-center gap-2 text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={kitchenStaples[item] || false}
                                                    onChange={() => toggleStaple(item)}
                                                    className="w-4 h-4 text-blue-500 rounded focus:ring-blue-500"
                                                />
                                                <span className="text-gray-700">{item}</span>
                                            </label>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="max-w-7xl mx-auto p-4 bg-gray-50 min-h-screen">
                    {/* Header */}
                    <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div className="flex justify-between items-start">
                            <div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                                    <ChefHat className="text-orange-500" />
                                    Kitchen Recipe Generator
                                </h1>
                                <p className="text-gray-600">üéØ Manage your kitchen inventory and generate AI recipes</p>
                            </div>
                            <div className="flex items-center gap-2 text-sm">
                                <div className={`flex items-center gap-1 ${statusInfo.color}`}>
                                    {statusInfo.icon}
                                    <span>{statusInfo.text}</span>
                                    {hasUnsavedChanges && (
                                        <span className="text-orange-500 text-xs">‚Ä¢ Unsaved</span>
                                    )}
                                </div>
                                <button
                                    onClick={() => setShowUserModal(true)}
                                    className="bg-purple-500 text-white px-3 py-1 rounded text-xs hover:bg-purple-600 flex items-center gap-1"
                                    title="Manage User"
                                >
                                    <User size={12} />
                                    User
                                </button>
                                <button
                                    onClick={() => {
                                        console.log('Force sync clicked');
                                        if (hasUnsavedChanges) {
                                            saveDataToDatabase().then(() => {
                                                loadDataFromDatabase(true);
                                            });
                                        } else {
                                            loadDataFromDatabase(true);
                                        }
                                    }}
                                    className="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600"
                                    disabled={isSyncing}
                                >
                                    {isSyncing ? 'Syncing...' : 'Force Sync'}
                                </button>
                                <button
                                    onClick={debugUserData}
                                    className="bg-gray-500 text-white px-3 py-1 rounded text-xs hover:bg-gray-600"
                                >
                                    Debug API
                                </button>
                                <button
                                    onClick={() => loadDataFromDatabaseDebug(true)}
                                    className="bg-purple-500 text-white px-3 py-1 rounded text-xs hover:bg-purple-600"
                                >
                                    Debug Load
                                </button>
                                <button
                                    onClick={() => {
                                        console.log('Current state:', { ingredients, equipment, kitchenStaples, customStaples, userId });
                                        console.log('Sync status:', syncStatus);
                                    }}
                                    className="bg-orange-500 text-white px-3 py-1 rounded text-xs hover:bg-orange-600"
                                >
                                    Debug State
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Expiring Soon Alert */}
                    {expiringSoon.length > 0 && (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <div className="flex items-center gap-2 mb-2">
                                <AlertTriangle className="text-red-500" />
                                <h3 className="font-semibold text-red-800">Ingredients Expiring Soon!</h3>
                            </div>
                            <div className="text-red-700 text-sm">
                                {expiringSoon.map(ing => ing.name).join(', ')} - Consider using these first!
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                        {/* Left Panel - Inventory Management */}
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <div className="flex gap-2 mb-6 flex-wrap">
                                <button
                                    onClick={() => setActiveTab('ingredients')}
                                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                        activeTab === 'ingredients' 
                                            ? 'bg-blue-500 text-white' 
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    ü•ò Ingredients ({ingredients.length})
                                </button>
                                <button
                                    onClick={() => setActiveTab('equipment')}
                                    className={`px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2 ${
                                        activeTab === 'equipment' 
                                            ? 'bg-blue-500 text-white' 
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    <Utensils />
                                    Equipment ({equipment.length})
                                </button>
                                <button
                                    onClick={() => setActiveTab('staples')}
                                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                        activeTab === 'staples' 
                                            ? 'bg-blue-500 text-white' 
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    üè∫ Kitchen Staples ({getSelectedStaplesCount()})
                                </button>
                                <button
                                    onClick={() => setActiveTab('recipes')}
                                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                        activeTab === 'recipes' 
                                            ? 'bg-blue-500 text-white' 
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    üìñ Saved Recipes ({savedRecipes.length})
                                </button>
                            </div>

                            {/* Ingredients Tab */}
                            {activeTab === 'ingredients' && (
                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-semibold text-gray-800">Your Ingredients</h2>
                                        <button
                                            onClick={addIngredient}
                                            className="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2 text-sm"
                                        >
                                            <Plus />
                                            Add
                                        </button>
                                    </div>
                                    
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {ingredients.map(ingredient => (
                                            <div
                                                key={ingredient.id}
                                                className={`p-4 rounded-lg border-2 ${
                                                    isExpiringSoon(ingredient.expires) ? 'border-red-300 bg-red-50' : 'border-gray-200 bg-gray-50'
                                                }`}
                                            >
                                                {editingItem?.type === 'ingredient' && editingItem?.id === ingredient.id ? (
                                                    <div className="space-y-3">
                                                        <input
                                                            value={ingredient.name}
                                                            onChange={(e) => updateIngredient(ingredient.id, 'name', e.target.value)}
                                                            className="w-full p-2 border rounded-lg"
                                                            placeholder="Ingredient name"
                                                        />
                                                        <div className="grid grid-cols-3 gap-2">
                                                            <input
                                                                type="number"
                                                                step="0.1"
                                                                value={ingredient.quantity}
                                                                onChange={(e) => updateIngredient(ingredient.id, 'quantity', parseFloat(e.target.value))}
                                                                className="p-2 border rounded-lg"
                                                                placeholder="Qty"
                                                            />
                                                            <input
                                                                value={ingredient.unit}
                                                                onChange={(e) => updateIngredient(ingredient.id, 'unit', e.target.value)}
                                                                className="p-2 border rounded-lg"
                                                                placeholder="Unit"
                                                            />
                                                            <input
                                                                type="date"
                                                                value={ingredient.expires}
                                                                onChange={(e) => updateIngredient(ingredient.id, 'expires', e.target.value)}
                                                                className="p-2 border rounded-lg"
                                                            />
                                                        </div>
                                                        <input
                                                            value={ingredient.category}
                                                            onChange={(e) => updateIngredient(ingredient.id, 'category', e.target.value)}
                                                            className="w-full p-2 border rounded-lg"
                                                            placeholder="Category (e.g., Protein, Vegetable)"
                                                        />
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => setEditingItem(null)}
                                                                className="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600"
                                                            >
                                                                Save
                                                            </button>
                                                            <button
                                                                onClick={() => setEditingItem(null)}
                                                                className="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600"
                                                            >
                                                                Cancel
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div>
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex-1">
                                                                <div className="font-medium text-gray-800 text-lg">{ingredient.name}</div>
                                                                <div className="text-sm text-gray-600">
                                                                    <span className="font-medium">{ingredient.quantity} {ingredient.unit}</span>
                                                                    <span className="mx-2">‚Ä¢</span>
                                                                    <span className="text-blue-600">{ingredient.category}</span>
                                                                </div>
                                                                <div className="text-xs text-gray-500 mt-1">
                                                                    Expires: {ingredient.expires}
                                                                    {isExpiringSoon(ingredient.expires) && (
                                                                        <span className="text-red-600 font-medium ml-2">‚ö†Ô∏è Use Soon!</span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-1 ml-4">
                                                                <button
                                                                    onClick={() => setEditingItem({ type: 'ingredient', id: ingredient.id })}
                                                                    className="text-blue-500 hover:text-blue-700 p-1"
                                                                    title="Edit"
                                                                >
                                                                    <Edit2 />
                                                                </button>
                                                                <button
                                                                    onClick={() => markAsUsed(ingredient.id)}
                                                                    className="text-orange-500 hover:text-orange-700 p-1"
                                                                    title="Mark as Used"
                                                                >
                                                                    <Check />
                                                                </button>
                                                                <button
                                                                    onClick={() => deleteIngredient(ingredient.id)}
                                                                    className="text-red-500 hover:text-red-700 p-1"
                                                                    title="Delete"
                                                                >
                                                                    <Trash2 />
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Quick quantity controls */}
                                                        <div className="flex items-center gap-2 mt-2">
                                                            <span className="text-xs text-gray-500">Quick update:</span>
                                                            <button
                                                                onClick={() => updateQuantity(ingredient.id, ingredient.quantity - 1)}
                                                                className="bg-red-100 text-red-600 hover:bg-red-200 rounded px-2 py-1 text-xs"
                                                                disabled={ingredient.quantity <= 1}
                                                            >
                                                                -1
                                                            </button>
                                                            <button
                                                                onClick={() => updateQuantity(ingredient.id, ingredient.quantity / 2)}
                                                                className="bg-yellow-100 text-yellow-600 hover:bg-yellow-200 rounded px-2 py-1 text-xs"
                                                            >
                                                                √∑2
                                                            </button>
                                                            <button
                                                                onClick={() => updateQuantity(ingredient.id, ingredient.quantity + 1)}
                                                                className="bg-green-100 text-green-600 hover:bg-green-200 rounded px-2 py-1 text-xs"
                                                            >
                                                                +1
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Equipment Tab */}
                            {activeTab === 'equipment' && (
                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-semibold text-gray-800">Your Equipment</h2>
                                        <button
                                            onClick={addEquipment}
                                            className="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2 text-sm"
                                        >
                                            <Plus />
                                            Add
                                        </button>
                                    </div>
                                    
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {equipment.map(item => (
                                            <div key={item.id} className="p-4 rounded-lg border-2 border-gray-200 bg-gray-50">
                                                {editingItem?.type === 'equipment' && editingItem?.id === item.id ? (
                                                    <div className="space-y-3">
                                                        <input
                                                            value={item.name}
                                                            onChange={(e) => updateEquipment(item.id, 'name', e.target.value)}
                                                            className="w-full p-2 border rounded-lg"
                                                            placeholder="Equipment name"
                                                        />
                                                        <input
                                                            value={item.type}
                                                            onChange={(e) => updateEquipment(item.id, 'type', e.target.value)}
                                                            className="w-full p-2 border rounded-lg"
                                                            placeholder="Type/Category"
                                                        />
                                                        <textarea
                                                            value={item.capabilities}
                                                            onChange={(e) => updateEquipment(item.id, 'capabilities', e.target.value)}
                                                            className="w-full p-2 border rounded-lg"
                                                            placeholder="What can this equipment do?"
                                                            rows={3}
                                                        />
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => setEditingItem(null)}
                                                                className="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600"
                                                            >
                                                                Save
                                                            </button>
                                                            <button
                                                                onClick={() => setEditingItem(null)}
                                                                className="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600"
                                                            >
                                                                Cancel
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex-1">
                                                            <div className="font-medium text-gray-800 text-lg">{item.name}</div>
                                                            <div className="text-sm text-blue-600 mb-2">{item.type}</div>
                                                            <div className="text-sm text-gray-600 leading-relaxed">{item.capabilities}</div>
                                                        </div>
                                                        <div className="flex gap-1 ml-4">
                                                            <button
                                                                onClick={() => setEditingItem({ type: 'equipment', id: item.id })}
                                                                className="text-blue-500 hover:text-blue-700 p-1"
                                                                title="Edit"
                                                            >
                                                                <Edit2 />
                                                            </button>
                                                            <button
                                                                onClick={() => deleteEquipment(item.id)}
                                                                className="text-red-500 hover:text-red-700 p-1"
                                                                title="Delete"
                                                            >
                                                                <Trash2 />
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'staples' && (
                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-semibold text-gray-800">Kitchen Staples</h2>
                                        <span className="text-sm text-gray-600">
                                            {getSelectedStaplesCount() + Object.values(customStaples).filter(Boolean).length} items selected
                                        </span>
                                    </div>
                                    
                                    <p className="text-sm text-gray-600 mb-4">
                                        Select the pantry staples you have on hand. These will be considered when generating recipes.
                                    </p>
                                    
                                    {/* Add Custom Staples Section HERE - before the existing categories */}
                                    {Object.keys(customStaples).length > 0 && (
                                        <div className="bg-white rounded-lg border border-gray-200 overflow-hidden mb-3">
                                            <div className="px-4 py-3 bg-purple-50 border-b">
                                                <div className="flex items-center gap-2 font-medium text-purple-800">
                                                    <span className="text-lg">‚ú®</span>
                                                    <span>Your Custom Staples</span>
                                                </div>
                                            </div>
                                            <div className="p-4">
                                                <div className="staples-grid">
                                                    {Object.keys(customStaples).map(item => (
                                                        <div key={item} className="flex items-center gap-2 text-sm hover:bg-gray-50 p-1 rounded">
                                                            <input
                                                                type="checkbox"
                                                                checked={customStaples[item] || false}
                                                                onChange={() => {
                                                                    trackUserAction();
                                                                    setCustomStaples(prev => ({
                                                                        ...prev,
                                                                        [item]: !prev[item]
                                                                    }));
                                                                }}
                                                                className="w-4 h-4 text-purple-500 rounded focus:ring-purple-500"
                                                            />
                                                            <span className="text-gray-700 flex-1">{item}</span>
                                                            <button
                                                                onClick={() => {
                                                                    trackUserAction();
                                                                    const newCustomStaples = { ...customStaples };
                                                                    delete newCustomStaples[item];
                                                                    setCustomStaples(newCustomStaples);
                                                                }}
                                                                className="text-red-500 hover:text-red-700 p-1"
                                                                title="Remove custom staple"
                                                            >
                                                                <X size={12} />
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                            
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {Object.entries(KITCHEN_STAPLES).map(([key, category]) => 
                                            renderStapleCategory(key, category)
                                        )}
                                        
                                        {/* Add Custom Staple Input Section */}
                                        <div className="bg-white rounded-lg border-2 border-dashed border-gray-300 p-4">
                                            <h4 className="font-medium text-gray-700 mb-2 flex items-center gap-2">
                                                <Plus size={16} />
                                                Add Your Own Staples
                                            </h4>
                                            <div className="grid grid-cols-4 gap-2 mb-3">
                                                {Object.keys(KITCHEN_STAPLES).map(categoryKey => (
                                                    <button
                                                        key={categoryKey}
                                                        onClick={() => setShowAddCustomStaple(categoryKey)}
                                                        className={`text-sm px-2 py-1 rounded border transition-colors ${
                                                            showAddCustomStaple === categoryKey 
                                                                ? 'bg-purple-500 text-white border-purple-500' 
                                                                : 'bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200'
                                                        }`}
                                                    >
                                                        {KITCHEN_STAPLES[categoryKey].name.split(' ')[0]}
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            {showAddCustomStaple && (
                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        value={customStapleInput}
                                                        onChange={(e) => setCustomStapleInput(e.target.value)}
                                                        placeholder={`Add custom ${KITCHEN_STAPLES[showAddCustomStaple].name.toLowerCase()}`}
                                                        className="flex-1 p-2 text-sm border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                                        onKeyPress={(e) => {
                                                            if (e.key === 'Enter' && customStapleInput.trim()) {
                                                                trackUserAction();
                                                                setCustomStaples(prev => ({
                                                                    ...prev,
                                                                    [customStapleInput.trim()]: false
                                                                }));
                                                                setCustomStapleInput('');
                                                                setShowAddCustomStaple('');
                                                            }
                                                        }}
                                                    />
                                                    <button
                                                        onClick={() => {
                                                            if (customStapleInput.trim()) {
                                                                trackUserAction();
                                                                setCustomStaples(prev => ({
                                                                    ...prev,
                                                                    [customStapleInput.trim()]: false
                                                                }));
                                                                setCustomStapleInput('');
                                                                setShowAddCustomStaple('');
                                                            }
                                                        }}
                                                        className="bg-purple-500 text-white px-3 py-2 rounded-lg hover:bg-purple-600 text-sm"
                                                        disabled={!customStapleInput.trim()}
                                                    >
                                                        Add
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            setShowAddCustomStaple('');
                                                            setCustomStapleInput('');
                                                        }}
                                                        className="bg-gray-300 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-400 text-sm"
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Saved Recipes Tab */}
                            {activeTab === 'recipes' && (
                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-semibold text-gray-800">Saved Recipes</h2>
                                        <span className="text-sm text-gray-600">
                                            {savedRecipes.length} recipes saved
                                        </span>
                                    </div>
                                    
                                    {savedRecipes.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <ChefHat className="mx-auto mb-2 text-gray-300" size={48} />
                                            <p>No saved recipes yet</p>
                                            <p className="text-sm">Generate and save your first recipe!</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3 max-h-96 overflow-y-auto">
                                            {savedRecipes.map(recipe => (
                                                <div key={recipe.id} className="p-4 rounded-lg border-2 border-gray-200 bg-gray-50">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <h3 className="font-medium text-gray-800 text-lg">{recipe.title}</h3>
                                                            <p className="text-xs text-gray-500 mb-2">
                                                                Saved: {new Date(recipe.createdAt).toLocaleDateString()}
                                                            </p>
                                                            {recipe.ingredients && recipe.ingredients.length > 0 && (
                                                                <p className="text-xs text-blue-600 mb-2">
                                                                    Used: {recipe.ingredients.slice(0, 3).join(', ')}
                                                                    {recipe.ingredients.length > 3 && ` + ${recipe.ingredients.length - 3} more`}
                                                                </p>
                                                            )}
                                                        </div>
                                                        <button
                                                            onClick={() => deleteRecipe(recipe.id)}
                                                            className="text-red-500 hover:text-red-700 p-1"
                                                            title="Delete Recipe"
                                                        >
                                                            <Trash2 />
                                                        </button>
                                                    </div>
                                                    <div className="text-sm text-gray-700 bg-white p-3 rounded border max-h-40 overflow-y-auto">
                                                        <div 
                                                            dangerouslySetInnerHTML={{ __html: formatRecipeText(recipe.content) }}
                                                        />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Right Panel - Recipe Generation */}
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <ChefHat className="text-orange-500" />
                                Generate Recipe
                            </h2>
                            
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Preferences & Notes (optional)
                                </label>
                                <textarea
                                    value={recipePreferences}
                                    onChange={(e) => setRecipePreferences(e.target.value)}
                                    className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                    placeholder="e.g., 'vegetarian', 'under 30 minutes', 'comfort food', 'use the sous vide', 'low carb'"
                                    rows={3}
                                />
                            </div>

                            <button
                                onClick={generateRecipe}
                                disabled={isGenerating || ingredients.length === 0}
                                className="w-full bg-orange-500 text-white py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 mb-4"
                            >
                                {isGenerating ? (
                                    <>
                                        <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                                        Generating Recipe...
                                    </>
                                ) : (
                                    <>
                                        <ChefHat size={20} />
                                        Generate Recipe ({ingredients.length} ingredients, {getSelectedStaplesCount()} staples)
                                    </>
                                )}
                            </button>

                            {ingredients.length === 0 && (
                                <p className="text-sm text-gray-500 text-center mb-4">
                                    Add some ingredients first to generate recipes!
                                </p>
                            )}

                            {generatedRecipe && (
                                <div className="mt-4 p-4 bg-gray-50 rounded-lg border max-h-96 overflow-y-auto">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                                            <ChefHat className="text-orange-500" size={18} />
                                            Your Custom Recipe:
                                        </h3>
                                        <button
                                            onClick={() => {
                                                if (savedRecipeContent !== generatedRecipe) {
                                                    saveRecipe(generatedRecipe);
                                                    setSavedRecipeContent(generatedRecipe);
                                                }
                                            }}
                                            disabled={savedRecipeContent === generatedRecipe}
                                            className={`px-3 py-1 rounded text-sm flex items-center gap-1 transition-colors ${
                                                savedRecipeContent === generatedRecipe 
                                                    ? 'bg-gray-400 text-gray-600 cursor-not-allowed' 
                                                    : 'bg-green-500 text-white hover:bg-green-600'
                                            }`}
                                        >
                                            {savedRecipeContent === generatedRecipe ? (
                                                <>
                                                    <Check size={12} />
                                                    Saved!
                                                </>
                                            ) : (
                                                <>
                                                    üíæ Save Recipe
                                                </>
                                            )}
                                        </button>
                                    </div>
                                    <div 
                                        className="text-gray-700 text-sm leading-relaxed"
                                        dangerouslySetInnerHTML={{ __html: formatRecipeText(generatedRecipe) }}
                                    />
                                </div>
                            )}
                        </div>
                    </div>

                    {/* User Management Modal */}
                    {showUserModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold flex items-center gap-2">
                                        <User />
                                        User Management
                                    </h3>
                                    <button
                                        onClick={() => setShowUserModal(false)}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        <X />
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div>
                                        <p className="text-sm text-gray-600 mb-2">
                                            Current User: <span className="font-mono bg-gray-100 px-2 py-1 rounded">
                                                {userId.startsWith('user_') ? 'Anonymous User' : userId}
                                            </span>
                                        </p>
                                        {userId.startsWith('user_') && (
                                            <p className="text-xs text-orange-600 mb-3">
                                                ‚ö†Ô∏è You're using an anonymous account. Set a username to access your data from other devices.
                                            </p>
                                        )}
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Set Username (to sync across devices)
                                        </label>
                                        <input
                                            type="text"
                                            value={usernameInput}
                                            onChange={(e) => setUsernameInput(e.target.value)}
                                            className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                            placeholder="e.g., john, mary_kitchen, chef123"
                                            maxLength={20}
                                        />
                                        <p className="text-xs text-gray-500 mt-1">
                                            Only letters, numbers, hyphens, and underscores. 2-20 characters.
                                        </p>
                                    </div>

                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => {
                                                if (setUsername(usernameInput)) {
                                                    setUsernameInput('');
                                                }
                                            }}
                                            className="flex-1 bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600"
                                            disabled={!usernameInput.trim()}
                                        >
                                            Set Username
                                        </button>
                                        {!userId.startsWith('user_') && (
                                            <button
                                                onClick={() => {
                                                    if (confirm('This will reset you to an anonymous user and clear your current data. Are you sure?')) {
                                                        clearUsername();
                                                    }
                                                }}
                                                className="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600"
                                            >
                                                Reset to Anonymous
                                            </button>
                                        )}
                                    </div>

                                    <div className="bg-blue-50 p-3 rounded-lg">
                                        <h4 className="font-medium text-blue-800 mb-2">How it works:</h4>
                                        <ul className="text-xs text-blue-700 space-y-1">
                                            <li>‚Ä¢ Set the same username on all your devices</li>
                                            <li>‚Ä¢ Your data will automatically sync between them</li>
                                            <li>‚Ä¢ Use simple names like "john" or "kitchen_main"</li>
                                            <li>‚Ä¢ No password needed - just remember your username</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Footer */}
                    <div className="mt-6 bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-lg p-4">
                        <div className="text-center">
                            <h3 className="font-semibold text-blue-800 mb-1">üéØ Real-time Sync Enabled!</h3>
                            <p className="text-blue-700 text-sm">
                                ‚Ä¢ Changes sync automatically across all your devices ‚Ä¢ Use any device - phone, laptop, tablet ‚Ä¢ Data is backed up in the cloud
                            </p>
                            <p className="text-blue-600 text-xs mt-2">
                                üì± Current User: <span className="font-mono bg-blue-100 px-1 rounded">{userId.startsWith('user_') ? 'Anonymous User' : userId}</span> 
                                {userId.startsWith('user_') && <span className="text-gray-500"> (Click "User" button to set a username)</span>}
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<RecipeGenerator />, document.getElementById('root'));
    </script>
</body>
</html>



















